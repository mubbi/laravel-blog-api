#!/bin/bash

echo "Running pre-push tests in Docker..."

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "Docker is not running. Please start Docker and try again."
    exit 1
fi

# Navigate to containers directory
cd "$(dirname "$0")/../containers"

# Run tests in Docker environment
echo "Starting test containers..."
docker-compose -f docker-compose.test.yml up -d

echo "Waiting for services to be ready..."
sleep 10

echo "Running tests..."
docker-compose -f docker-compose.test.yml exec -T laravel_blog_api_test bash -c "
    composer install --no-interaction --prefer-dist --optimize-autoloader
    cp .env.testing.docker .env.testing
    php artisan config:clear --env=testing
    php artisan cache:clear --env=testing
    php artisan migrate:fresh --seed --env=testing
    php artisan test --parallel --recreate-databases --coverage-html reports/coverage
    ./vendor/bin/phpstan analyse --memory-limit=2G
"

# Get the exit code from the tests
TEST_EXIT_CODE=$?

# Stop the test containers
echo "Stopping test containers..."
docker-compose -f docker-compose.test.yml down

if [ $TEST_EXIT_CODE -ne 0 ]; then
    echo "Tests or analysis failed. Push aborted."
    exit 1
fi

echo "All checks passed. Proceeding with push..."
exit 0
